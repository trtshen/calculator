<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>TNB bill calculator</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<style>
		table th, td {
			text-align:center;
		}
		.spacer {
			padding-top: 1.5em;
		}
	</style>
</head>

<body ng-app="tnb" ng-cloak>
	<main class="text-center container">
		<section class="row" ng-controller="billCtrl">
			<header>
				<h1>TNB Calculator 2023 (Household)</h1>
				<p>Calculate your electricity bill here!</p>
			</header>

			<section class="col-md-12">
				<table class="table table-striped">
					<thead>
						<tr>
							<th>Block</th>
							<th>Tariff Block (kWh)</th>
							<th>Rate (cents)</th>
						</tr>
					</thead>
					<tbody>
						<tr ng-repeat="rate in ::rates">
							<td>{{$index + 1}}</td>
							<td>{{rate.limit}}</td>
							<td>{{rate.charge}}</td>
						</tr>
					</tbody>
				</table>
			</section>

			<section class="col-md-12">
				<form ng-submit="calculate()">
					<div class="input-group input-group-lg">
						<span class="input-group-addon" id="consumption">Consumption (kWh)</span>
						<input type="number" class="form-control" placeholder="kWh" aria-describedby="consumption" ng-model="kwh" autofocus ng-change="calculate()">
					</div>
				</form>
			</section>

			<section class="col-md-12 spacer">
				<form ng-submit="refinance(finance)">
					<div class="input-group input-group-lg">
						<span class="input-group-addon" id="prediction">Cost (MYR)</span>
						<input type="number" class="form-control" placeholder="0.00" aria-describedby="prediction" ng-model="finance" ng-change="refinance(finance)">
					</div>
				</form>
			</section>

			<section class="col-md-12 spacer" ng-if="consumable > 0">
				<div class="panel panel-default">
					<div class="panel-heading">
						Consumable kWh (Experimental)
					</div>
					<table class="table table-striped">
						<tbody>
							<tr>
								<td width="50%">Predicted Consumable kWh</td>
								<td>{{consumable}} kWh</td>
							</tr>
						</tbody>
					</table>
				</div>
			</section>

			<section class="col-md-12 spacer" ng-if="total > 0">
				<div class="panel panel-default">
					<div class="panel-heading">
						Billing Summary
					</div>
					<table class="table table-striped">
						<tbody>
							<tr>
								<td width="50%">Total (Before Any Rebate/fee)</td>
								<td>RM{{totalOfUsage}}</td>
							</tr>
							<tr>
								<td width="50%">Total (Before GST)</td>
								<td>RM{{total}}</td>
							</tr>
							<tr>
								<td>GST</td>
								<td>RM{{gst}}</td>
							</tr>
							<tr>
								<td>Renewable Energy Fee</td>
								<td>RM{{renewEnergyFee}}</td>
							</tr>
							<tr>
								<td>ICPT Rebate (RM0.02/kwh - Dec 2023)</td>
								<td>RM{{icpt}}</td>
							</tr>
							<tr>
								<td>Total (After GST)</td>
								<td>RM{{gstTotal}}</td>
							</tr>
						</tbody>
					</table>
				</div>
			</section>

			<section class="col-md-12 spacer">
				<div class="panel panel-default">
				  <div class="panel-heading">Notes</div>
				  <div class="panel-body">
					<p class="text-info">Minimum bill amount of Domestic Tariff is RM3.00</p>
					<p class="text-info">ICPT Rebate only available for consumption <a href="https://www.tnb.com.my/faq/tariff" target="_blank">exceed 300 kWh</a></p>
					<p class="text-info">ICPT abbr. of <strong><a href="https://www.tnb.com.my/faq/tariff#what-is-imbalance-cost-pass-through-icpt" target="_blank">Imbalance Cost Pass-Through</a></strong></p>
				  </div>
				</div>
			</section>

		</section>
	</main>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/2.1.3/ui-bootstrap.min.js"></script>
	<script>
		var tnb = angular.module('tnb', []);
		tnb.controller('billCtrl', ['$scope', function ($scope) {
			$scope.kwh = null;
			$scope.gst = 0;
			$scope.rates = [
				{
					level: 1,
					charge: 21.8,
					limit: 200,
				},
				{
					level: 2,
					charge: 33.4,
					limit: 100
				},
				{
					level: 3,
					charge: 51.6,
					limit: 300
				},
				{
					level: 4,
					charge: 54.6,
					limit: 300
				},
				{
					level: 5,
					charge: 57.1
				}
			];

			$scope.calculate = function () {
				$scope.finance = undefined; // Reset the finance amount
				var totalOfUsage = 0;
				var totalWithoutGST = 0;
				var totalWithGST = 0;
				var kwhRemaining = $scope.kwh;
				var totalIcptRebate = 0;
				var icptRate = 0.02; // ICPT rebate for each kWh used
				var gstRate = 0.06;

				// Iterate over the rates and calculate the cost for each block
				angular.forEach($scope.rates, function (rate) {
					if (kwhRemaining > 0) {
						var chargeableKwh = (rate.limit) ? Math.min(kwhRemaining, rate.limit) : kwhRemaining;
						var costForBlock = chargeableKwh * (rate.charge / 100);
						var icptRebate = (icptRate * chargeableKwh);
						totalIcptRebate += icptRebate;
						if (rate.level < 4) {
							// For the first three blocks, no GST is applied
							totalWithoutGST += costForBlock - icptRebate;
						} else {
							// For the fourth block and onwards, GST is applied
							totalWithGST += costForBlock - icptRebate;
						}

						kwhRemaining -= chargeableKwh;
						totalOfUsage += costForBlock;
					}
				});

				// Apply GST to the total cost for GST applicable blocks
				var gstAmount = totalWithGST * gstRate;

				// Sum up total before GST, then add GST, and finally subtract ICPT rebate
				var totalBeforeGST = totalWithoutGST + totalWithGST;
				var renewEnergyFee = totalOfUsage * 0.016;
				var totalAfterGST = totalBeforeGST + renewEnergyFee + gstAmount;

				// Update scope variables for display in the view
				$scope.totalOfUsage = totalOfUsage.toFixed(2);
				$scope.total = totalBeforeGST.toFixed(2);
				$scope.gst = gstAmount.toFixed(2);
				$scope.icpt = totalIcptRebate.toFixed(2);
				$scope.gstTotal = totalAfterGST.toFixed(2);
				$scope.renewEnergyFee = renewEnergyFee.toFixed(2);
			};

			// experimental
			$scope.refinance = function (amount) {
				$scope.kwh = undefined; // Reset the kWh
				$scope.consumable = 0; // Reset the consumable kWh
				if (amount <= 0) {
					// If the amount is 0 or less, no need to calculate anything
					return;
				}

				var consumableKwh = 0;
				var gstRate = 0.06;
				var icptRate = 0.02; // ICPT rebate for each kWh used
				var renewEnergyFeeRate = 0.016; // Renewable Energy Fund

				// Remove the Renewable Energy Fund fee from the amount
				var netAmount = amount / (1 + renewEnergyFeeRate);

				// Calculate the reverse for GST applied amount (for consumption above 600 kWh)
				if (netAmount > $scope.rates[3].limit * ($scope.rates[3].charge / 100)) {
					var gstApplicableAmount = (netAmount - $scope.rates[3].limit * ($scope.rates[3].charge / 100)) / (1 + gstRate);
					consumableKwh += (gstApplicableAmount / ($scope.rates[3].charge / 100)) + $scope.rates[3].limit;
					netAmount -= gstApplicableAmount + (gstApplicableAmount * gstRate);
				}

				// Calculate the reverse for non-GST applied amount (for consumption below 600 kWh)
				angular.forEach($scope.rates, function (rate) {
					if (rate.level < 4 && netAmount > 0) { // Only consider non-GST blocks and if there is an amount left
						var maxCostForRate = rate.limit * (rate.charge / 100);
						var icptRebateForRate = icptRate * rate.limit;
						var costForRateWithoutRebate = Math.min(netAmount, maxCostForRate) + icptRebateForRate;

						if (costForRateWithoutRebate <= icptRebateForRate) {
							// This means the amount is not enough to buy any kWh after ICPT rebate is considered
							return;
						}

						var kwhForRate = costForRateWithoutRebate / ((rate.charge / 100) + icptRate);
						consumableKwh += kwhForRate;
						netAmount -= costForRateWithoutRebate - icptRebateForRate;
					}
				});

				// Update the consumable kWh on scope
				$scope.consumable = Math.max(0, consumableKwh).toFixed(0);
			};

			function getDecimal(num) {
				return parseFloat(num).toFixed(2);
			}
		}]);
	</script>
</body>
</html>
